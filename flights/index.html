<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flights — PurpleFlights</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f7f7fb;color:#191a1f}
    .container{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 6px 12px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    label{display:block;font-size:12px;color:#6b7280;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .btn{display:inline-block;padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;text-decoration:none;color:#fff;background:#1f2937}
    h1{font-size:44px;margin:24px 0;text-align:center}
  </style>
</head>
<body>
  <main class="container">
    <h1>Flights</h1>
    <form id="search" class="card grid">
      <div><label>From</label><input id="from" placeholder="Bangkok (BKK)" /></div>
      <div><label>To</label><input id="to" placeholder="London (LON)" /></div>
      <div><label>Depart</label><input id="date" type="date" /></div>
      <div><label>Return</label><input id="ret" type="date" /></div>
      <div><label>Cabin</label>
        <select id="cabin">
          <option value="ECONOMY">Economy</option>
          <option value="PREMIUM_ECONOMY">Premium Economy</option>
          <option value="BUSINESS">Business</option>
          <option value="FIRST">First</option>
        </select>
      </div>
      <div><label>Adults</label><input id="adults" type="number" min="1" max="9" value="1" /></div>
      <div style="align-self:end"><button id="go" class="btn" type="button">Test selection</button></div>
    </form>
  </main>

<script type="module">
  import { attachAutocomplete } from '/js/lib/autocomplete.js';
  const fromEl = document.getElementById('from');
  const toEl   = document.getElementById('to');
  attachAutocomplete(fromEl); attachAutocomplete(toEl);

  // Stop native submit
  document.getElementById('search').addEventListener('submit', (e)=> e.preventDefault());

  // Guess a sane default currency once (GB→GBP, EU→EUR, TH→THB, SG→SGD, AU→AUD, CA→CAD, else USD)
  const curSel = document.getElementById('currency');
  if (curSel) {
    const l=(navigator.language||'en-US').toLowerCase();
    const guess = l.endsWith('-gb') ? 'GBP'
                : l.endsWith('-au') ? 'AUD'
                : l.endsWith('-ca') ? 'CAD'
                : l.endsWith('-sg') ? 'SGD'
                : l.endsWith('-th') ? 'THB'
                : (/-de|-fr|-es|-it|-nl|-pt|-ie|-be|-fi|-at/.test(l) ? 'EUR' : 'USD');
    if ([...curSel.options].some(o => o.value === guess)) curSel.value = guess;
  }

  // Robust IATA picker (prefers city code)
  function pickCode(input){
    const a=(input.dataset.city||'').toUpperCase();
    const b=(input.dataset.code||'').toUpperCase();
    if(/^[A-Z]{3}$/.test(a)) return a;
    if(/^[A-Z]{3}$/.test(b)) return b;
    const v=(input.value||'').trim().toUpperCase();
    const m=v.match(/\(([A-Z]{3})\)/); if(m) return m[1];
    const t=v.replace(/[^A-Z]/g,''); return /^[A-Z]{3}$/.test(t)?t:'';
  }

  document.getElementById('go').addEventListener('click', () => {
    const data = {
      from: pickCode(fromEl),
      to:   pickCode(toEl),
      date: document.getElementById('date').value || '',
      ret:  document.getElementById('ret').value  || '',
      adults: document.getElementById('adults').value || '1',
      cabin:  document.getElementById('cabin').value  || 'ECONOMY',
      currency: (curSel?.value || 'USD').toUpperCase(),   // <-- include currency
    };
    if (!data.from || !data.to || !data.date) { alert('Fill From, To, and Depart.'); return; }
    window.open('/flights/results.html?' + new URLSearchParams(data).toString(), '_blank', 'noopener');
  });
</script>
