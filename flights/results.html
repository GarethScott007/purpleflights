<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Results — PurpleFlights</title>
  <link rel="stylesheet" href="/css/theme.css"/>
</head>
<body>
<header class="topbar">
  <div class="container row spread">
    <a class="brand" href="/">PurpleFlights</a>
    <nav class="row gap">
      <a class="pill" href="/flights/">Flights</a>
      <a class="pill ghost" href="/#">Group Trips</a>
      <span class="badge">Patent pending</span>
      <a class="pill ghost" href="/#">Contact</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="row spread" style="margin:8px 0 12px">
    <div id="meta" class="small muted"></div>
    <div class="row gap">
      <!-- Hotels landing (TP) -->
      <a id="hotels" class="pill" target="_blank" rel="noopener">Hotels</a>
    </div>
  </div>

  <div id="results" class="grid"></div>
</main>

<footer class="container foot small">© <span id="y"></span> PurpleFlights</footer>
<script>document.getElementById('y').textContent=new Date().getFullYear();</script>

<script>
const qs = new URLSearchParams(location.search);
const req = {
  from:(qs.get('from')||'').toUpperCase(),
  to:(qs.get('to')||'').toUpperCase(),
  date:qs.get('date')||'',
  ret:qs.get('ret')||'',
  adults:+(qs.get('adults')||1),
  currency:(qs.get('currency')||'USD').toUpperCase(),
};
document.getElementById('meta').textContent =
  `${req.from} → ${req.to} • ${req.date}${req.ret?(' → '+req.ret):''}`;

// Hotels button (Travelpayouts Hotels landing, marker=670577)
(function(){
  const h = document.getElementById('hotels');
  const u = new URL('https://hotels-comparer.com/');
  u.searchParams.set('marker','670577');
  if (req.date) u.searchParams.set('checkIn', req.date);
  if (req.ret)  u.searchParams.set('checkOut', req.ret);
  h.href = u.toString();
})();

const resEl=document.getElementById('results');
resEl.innerHTML='<div class="card" style="padding:16px">Searching…</div>';

fetch('/api/search',{method:'POST',headers:{'content-type':'application/json'},
  body:JSON.stringify({from:req.from,to:req.to,date:req.date,ret:req.ret,currency:req.currency})})
.then(r=>r.json())
.then(data=>{
  if(data?.error){ resEl.innerHTML = `<div class="card" style="padding:16px">Search error: ${data.error}</div>`; return; }
  const offers = Array.isArray(data?.data) ? data.data : [];
  if(!offers.length){ resEl.innerHTML='<div class="card" style="padding:16px">No results.</div>'; return; }

  resEl.innerHTML='';
  offers.slice(0,30).forEach(o=>{
    const dep=o.origin||req.from, arr=o.destination||req.to;
    const price=o.price, cur=(o.currency||req.currency||'USD').toUpperCase();
    const carrier=(o.airline||'').toUpperCase()||'–';

    const base = new URLSearchParams({
      from: dep, to: arr,
      date: req.date, return: req.ret,
      adults: String(req.adults),
      currency: cur,
      redirect: '1'
    });

    const kiwiHref = '/api/book?p=kiwi&' + base.toString();        // if you prefer direct links: build them here instead
    const aviaHref = '/api/book?p=aviasales&' + base.toString();

    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip">${carrier}</span>
          <strong style="margin-left:10px">${dep} → ${arr}</strong>
        </div>
      </div>
      <div class="muted small" style="margin:8px 0 14px">Indicative fare</div>
      <div class="row">
        <a class="btn gradient no-affiliate" href="${kiwiHref}" target="_blank" rel="noopener">Book (Kiwi) — ${price} ${cur}</a>
        <a class="btn ghost no-affiliate" href="${aviaHref}" target="_blank" rel="noopener">Book (Aviasales)</a>
      </div>
    `;
    resEl.appendChild(card);
  });
})
.catch(e=>{ resEl.innerHTML=`<div class="card" style="padding:16px">Search failed: ${e.message}</div>`; });
</script>
</body>
</html>
