<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Results — PurpleFlights</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f7f7fb;color:#191a1f}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 6px 12px rgba(0,0,0,.05)}
    .tag{display:inline-block;background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;font-size:12px;padding:2px 8px;border-radius:999px}
    .btn{display:inline-block;padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;text-decoration:none;color:#fff;background:#1f2937}
    .btn.ghost{background:#fff;color:#1f2937}
    .muted{color:#6b7280}.small{font-size:12px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    h1{margin:16px 0 8px}
  </style>
</head>
<body>
  <main class="container">
    <h1>Results</h1>
    <div id="meta" class="muted small"></div>
    <div id="results" class="grid"></div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const req = {
      from: (qs.get('from')||'').toUpperCase(),
      to: (qs.get('to')||'').toUpperCase(),
      date: qs.get('date')||'',
      ret: qs.get('ret')||'',
      adults: +(qs.get('adults')||1),
      cabin: qs.get('cabin')||'ECONOMY',
      currency: (qs.get('currency')||'USD').toUpperCase(),
    };
    document.getElementById('meta').textContent =
      `${req.from} → ${req.to} • ${req.date}${req.ret?(' → '+req.ret):''}`;

    const resEl = document.getElementById('results');
    resEl.innerHTML = '<div class="card">Searching…</div>';

    fetch('/api/search', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        from: req.from, to: req.to, date: req.date, ret: req.ret, currency: req.currency
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data && data.error) {
        resEl.innerHTML = `<div class="card">Search error: ${data.error}</div>`;
        return;
      }
      const offers = Array.isArray(data?.data) ? data.data : [];
      if (!offers.length) { resEl.innerHTML = '<div class="card">No results.</div>'; return; }

      resEl.innerHTML = '';
      offers.slice(0, 30).forEach(o => {
        const dep = o.origin || req.from;
        const arr = o.destination || req.to;
        const price = o.price;
        const currency = (o.currency || req.currency || 'USD').toUpperCase();
        const airline = (o.airline || '').toUpperCase() || '—';

        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div class="row"><span class="tag">${airline}</span><strong style="margin-left:8px">${dep} → ${arr}</strong></div>
          <div class="muted small" style="margin:6px 0 12px">Indicative fare</div>
          <div class="row">
            <a class="btn" data-p="kiwi">Book — ${price} ${currency}</a>
            <a class="btn ghost" data-p="aviasales">Book (Aviasales)</a>
          </div>
        `;

        // Both buttons call /api/book with provider p=...
        for (const a of card.querySelectorAll('a[data-p]')) {
          a.href = '#'; a.target = '_blank'; a.rel = 'noopener';
          const provider = a.dataset.p;
          a.addEventListener('click', async (ev) => {
            ev.preventDefault();
            const q2 = new URLSearchParams({
              p: provider,
              from: dep, to: arr,
              date: req.date, return: req.ret,
              adults: String(req.adults),
              currency: currency
            });
            try {
              const r = await fetch('/api/book?' + q2.toString());
              const j = await r.json();
              if (j.ok && j.url) window.open(j.url, '_blank', 'noopener');
            } catch {}
          });
        }

        resEl.appendChild(card);
      });
    })
    .catch(e => { resEl.innerHTML = `<div class="card">Search failed: ${e.message}</div>`; });
  </script>
</body>
</html>
